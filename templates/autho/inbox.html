{% extends '../base.html' %}
{% load static %}
{% load humanize %}


{% block content %}
<style>
  .chat-list h3 {
      color: #222;
      font-size: 16px;
      font-weight: 500;
      line-height: 1.5;
      text-transform: capitalize;
      margin-bottom: 0;
  }

  .chat-list p {
      color: #343434;
      font-size: 14px;
      font-weight: 400;
      line-height: 1.5;
      text-transform: capitalize;
      margin-bottom: 0;
  }

  .chat-list a.d-flex {
      margin-bottom: 15px;
      position: relative;
      text-decoration: none;
  }

  .chat-list .active {
      display: block;
      content: "";
      clear: both;
      position: absolute;
      bottom: 3px;
      left: 34px;
      height: 12px;
      width: 12px;
      background: #00db75;
      border-radius: 50%;
      border: 2px solid #fff;
  }

  .msg-body ul li.sender {
      display: block;
      width: 100%;
      position: relative;
  }

  .msg-body ul li.sender:before {
      display: block;
      clear: both;
      content: "";
      position: absolute;
      top: -6px;
      left: -7px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 12px 15px 12px;
      border-color: transparent transparent #f5f5f5 transparent;
      -webkit-transform: rotate(-37deg);
      -ms-transform: rotate(-37deg);
      transform: rotate(-37deg);
  }

  .msg-body ul li.sender p {
      color: #000;
      font-size: 14px;
      line-height: 1.5;
      font-weight: 400;
      padding: 15px;
      background: #f5f5f5;
      display: inline-block;
      border-bottom-left-radius: 10px;
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px;
      margin-bottom: 0;
  }

  .msg-body ul li.sender p b {
      display: block;
      color: #180660;
      font-size: 14px;
      line-height: 1.5;
      font-weight: 500;
  }

  .msg-body ul li.repaly {
      display: block;
      width: 100%;
      text-align: right;
      position: relative;
  }

  .msg-body ul li.repaly:before {
      display: block;
      clear: both;
      content: "";
      position: absolute;
      bottom: 15px;
      right: -7px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 12px 15px 12px;
      border-color: transparent transparent #4b7bec transparent;
      -webkit-transform: rotate(37deg);
      -ms-transform: rotate(37deg);
      transform: rotate(37deg);
  }

  .msg-body ul li.repaly p {
      color: #fff;
      font-size: 14px;
      line-height: 1.5;
      font-weight: 400;
      padding: 15px;
      background: #4b7bec;
      display: inline-block;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      border-bottom-left-radius: 10px;
      margin-bottom: 0;
  }

  .msg-body ul li.repaly p b {
      display: block;
      color: #061061;
      font-size: 14px;
      line-height: 1.5;
      font-weight: 500;
  }

  .msg-body ul li.repaly:after {
      display: block;
      content: "";
      clear: both;
  }

  .time {
      display: block;
      color: #000;
      font-size: 12px;
      line-height: 1.5;
      font-weight: 400;
  }

  li.repaly .time {
      margin-right: 20px;
  }

  .divider {
      position: relative;
      z-index: 1;
      text-align: center;
  }
  .divider:after {
      display: block;
      content: "";
      clear: both;
      position: absolute;
      top: 12px;
      left: 0;
      border-top: 1px solid #ebebeb;
      width: 100%;
      height: 100%;
      z-index: -1;
  }


  .msg-body h6 {
      text-align: center;
      font-weight: normal;
      font-size: 14px;
      line-height: 1.5;
      color: #222;
      background: #fff;
      display: inline-block;
      padding: 0 5px;
      margin-bottom: 0;
  }
  .send-box {
      padding: 15px;
      border-top: 1px solid #ccc;
  }

  .send-box form {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
  }

  .send-box .form-control {
      display: block;
      width: 85%;
      padding: 0.375rem 0.75rem;
      font-size: 14px;
      font-weight: 400;
      line-height: 1.5;
      color: #222;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ccc;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }

  .send-box button {
      border: none;
      background: #3867d6;
      padding: 0.375rem 5px;
      color: #fff;
      border-radius: 0.25rem;
      font-size: 14px;
      font-weight: 400;
      width: 24%;
      margin-left: 1%;
  }

  .send-box button i {
      margin-right: 5px;
  }
  .send-btns .button-wrapper {
      position: relative;
      width: 125px;
      height: auto;
      text-align: left;
      margin: 0 auto;
      display: block;
      background: #f6f7fa;
      border-radius: 3px;
      padding: 5px 15px;
      float: left;
      margin-right: 5px;
      margin-bottom: 5px;
      overflow: hidden;
  }

  .send-btns .button-wrapper span.label {
      position: relative;
      z-index: 1;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-align: center;
      -ms-flex-align: center;
      align-items: center;
      width: 100%;
      cursor: pointer;
      color: #343945;
      font-weight: 400;
      text-transform: capitalize;
      font-size: 13px;
  }

  #upload {
      display: inline-block;
      position: absolute;
      z-index: 1;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
  }

  .send-btns .attach .form-control {
      display: inline-block;
      width: 120px;
      height: auto;
      padding: 5px 8px;
      font-size: 13px;
      font-weight: 400;
      line-height: 1.5;
      color: #343945;
      background-color: #f6f7fa;
      background-clip: padding-box;
      border: 1px solid #f6f7fa;
      border-radius: 3px;
      margin-bottom: 5px;
  }

  .send-btns .button-wrapper span.label img {
      margin-right: 5px;
  }
  .add-apoint {
      display: inline-block;
      margin-left: 5px;
  }

  .add-apoint a {
      text-decoration: none;
      background: #f6f7fa;
      border-radius: 8px;
      padding: 8px 8px;
      font-size: 13px;
      font-weight: 400;
      line-height: 1.2;
      color: #343945;
  }

  .add-apoint a svg {
      margin-right: 5px;
  }
  #all_chats {
      height: 53rem;
  }
  @media screen and (max-width: 767px) {
      #all_chats {
          height: 20rem;
      }
  }
  .file-label {
      cursor: pointer;
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
  crossorigin="anonymous"></script>

<!-- Other head content -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
<br><br><br>
<div class="container" data-aos="fade-up">
  <div class="row">
    <div class="col-md-4">
        <div id="all_chats" class="card overflow-auto">
            <div class="card-body">
                <hr>
                {% for message in messages %}
                <div class="chat-list">
                    <a href="{% url 'directs' message.user.username %}" class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <img style="width: 40px; height: 40px;" class="img-fluid rounded-circle shadow-4-strong"
                                src="{{ message.user.profile.user_image.url }}"
                                alt="user img">
                            <span class="active"></span>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3>{{ message.user.first_name }} {{ message.user.last_name }}</h3>
                            <p>@{{ message.user }}</p>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                  <div style="padding-right: 5px;" class="flex-shrink-0 mr-3">
                    <h3>Inbox</h3>
                  </div>
                </div>
            <hr>
            </div>
            <div style="height: 39rem;" class="modal-body overflow-auto">
                <div class="msg-body">
                    <ul>
                        {% for direct in directs %}
                            {% if direct.sender == request.user %}
                                <li class="repaly">
                                    <p> {{ direct.body }}</p>
                                    <span class="time">{{ direct.date }}</span>
                                    {% if direct.file %}
                                        <p>
                                            <a href="{{ direct.file.url }}" target="_blank">View File</a>
                                        </p>
                                    {% endif %}
  
                                </li>
                            {% else%}
                                <li class="sender">
                                    <p>{{ direct.body }}</p>
                                    <span class="time">{{ direct.date }}</span>
                                    {% if direct.file %}
                                     <p>
                                        <a href="{{ direct.file.url }}" target="_blank">View File</a>
                                     </p>
                                    {% endif %}
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="send-box">
                <form role="form" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="to_user" id="" value="{{ active_direct }}">
                    <input name="body" type="text" id="" value="" class="form-control" placeholder="typ message">
  
                    <input type="file" name="file" id="file" style="display:none;" />
                    <label class="btn btn-warning btn-sm" for="file" class="file-label"><i class="fa fa-paperclip" aria-hidden="true"></i></label>
  
                    <button type="submit"><i class="fa fa-paper-plane" aria-hidden="true"></i>Send</button>
                </form>
            </div>          
        </div>
    </div>
  </div>
</div>
<script>
  const currentUser = "{{ request.user.username }}";
  const activeDirect = "{{ active_direct }}";

  function sendMessage() {
      const toUser = document.querySelector('input[name="to_user"]').value;
      const body = document.querySelector('input[name="body"]').value;
      const fileInput = document.querySelector('input[type="file"]');
      const formData = new FormData();

      formData.append('to_user', toUser);
      formData.append('body', body);

      if (fileInput.files.length > 0) {
          formData.append('file', fileInput.files[0]);
      }

      fetch('/send_message_ajax/', {
          method: 'POST',
          headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: formData,
      })
      .then(response => response.json())
      .then(data => {
          if (data.status === 'success') {
              document.querySelector('input[name="body"]').value = '';
              fileInput.value = ''; // Add this line to clear the file input
              getMessages(toUser).then(() => {
                  scrollToBottom();
              });
          } else {
              console.error('Failed to send message');
          }
      })
      .catch(error => {
          console.error('Error:', error);
      });
  }


  function getMessages(username) {
      return fetch(`/get_messages_ajax/${username}/`)
          .then(response => response.json())
          .then(data => {
              console.log(data);  
              const messageList = document.querySelector('.msg-body ul');
              const oldMessageCount = messageList.children.length;

              messageList.innerHTML = '';

              data.messages.forEach((message, index) => {

                  const listItem = document.createElement('li');
                  listItem.className = message.sender === currentUser ? 'repaly' : 'sender';

                  const messageText = document.createElement('p');
                  messageText.textContent = message.body;
                  listItem.appendChild(messageText);

                  const messageTime = document.createElement('span');
                  messageTime.className = 'time';
                  messageTime.textContent = message.date;
                  listItem.appendChild(messageTime);

                  if (message.file_url) {
                      const card = document.createElement('div');
                      card.className = 'card mt-2';

                      const cardBody = document.createElement('div');
                      cardBody.className = 'card-body';

                      const fileLink = document.createElement('a');
                      fileLink.href = message.file_url;
                      fileLink.target = '_blank';
                      fileLink.className = 'btn btn-danger';

                      const fileIcon = document.createElement('i');
                      fileIcon.className = 'bi bi-file-earmark'; // Add Bootstrap icon class
                      fileLink.appendChild(fileIcon); // Add the fileIcon to the fileLink

                      const viewFileText = document.createTextNode(' View File');
                      fileLink.appendChild(viewFileText); // Add the 'View File' text after the icon

                      cardBody.appendChild(fileLink);
                      card.appendChild(cardBody);
                      listItem.appendChild(card);
                  }


                  messageList.appendChild(listItem);
              });


              const newMessageCount = messageList.children.length;
              return oldMessageCount !== newMessageCount;
          });
  }

  function scrollToBottom() {
      const messageContainer = document.querySelector('.modal-body.overflow-auto');
      messageContainer.scrollTop = messageContainer.scrollHeight;
  }

  function pollNewMessages() {
      setInterval(() => {
          getMessages(activeDirect).then(newMessageAdded => {
              if (newMessageAdded) {
                  scrollToBottom();
              }
          });
      }, 3000);
  }

  document.querySelector('form').addEventListener('submit', event => {
      event.preventDefault();
      sendMessage();
  });

  getMessages(activeDirect).then(() => {
      scrollToBottom();
  });
  pollNewMessages();
</script>
{% endblock %}